name: Build Android App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Smart Flatten Structure
        run: |
          # --- 智能修复：自动寻找 app 文件夹并移动到根目录 ---
          echo "正在寻找 app 文件夹..."
          
          # 查找 app 文件夹的位置
          APP_PATH=$(find . -type d -name "app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: 根本找不到 app 文件夹！请检查是否上传了正确的文件。"
            ls -R
            exit 1
          fi

          echo "找到 app 文件夹位置: $APP_PATH"
          
          # 获取 app 的父目录
          PARENT_DIR=$(dirname "$APP_PATH")
          
          # 如果 app 不在根目录，就把父目录里的所有东西移出来
          if [ "$PARENT_DIR" != "." ]; then
             echo "检测到嵌套目录，正在将 $PARENT_DIR 的内容移动到根目录..."
             mv "$PARENT_DIR"/* .
             mv "$PARENT_DIR"/.* . 2>/dev/null || true
             rm -rf "$PARENT_DIR"
          fi
          
          echo "最终目录结构:"
          ls -F

      - name: Fix Project & Wrapper
        run: |
          # 1. 强制生成 settings.gradle (防止找不到 app 模块)
          echo "include ':app'" > settings.gradle
          
          # 2. 重新生成 gradle wrapper (防止上传时漏传 jar 包)
          gradle wrapper

      - name: Build Debug APK
        run: |
          chmod +x gradlew
          # 打包 Debug 版，自带签名，安装无障碍
          ./gradlew :app:assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
